import Head from 'next/head'
import styles from '@/styles/Home.module.css'
import React, {useState, useEffect } from 'react';

export default function Home() {
  const [conversation, setConversation] = useState<Array<string>>([]);
  const [chatboxDisabled, setChatboxDisabled] = useState<boolean>(false);
  const [response, setResponse] = useState<string>('');
  const [query, setQuery] = useState<string>('');
  const [currentModel, setCurrentModel] = useState<string>('curie')
  const [currentMood, setCurrentMood] = useState<string>('chat')

  useEffect(() => {
    if(response) {
      setConversation([...conversation, response])
      setChatboxDisabled(false)
      setResponse('')
      console.log({conversation});
    }
  }, [response])

  useEffect(() => {
    if(query) {
      getResponse().then(json => {
        console.log(json)
        setResponse(json.response);
        setQuery('')
      })
    }
  }, [query])

  const appendToConversation = async (query: string) => {
    setConversation([...conversation, query]);
    setQuery(query);
  }

  const getResponse = async () => {
    const response = await fetch('/api/get-response', {
      method: 'POST',
      headers: {
        "Content-Type": "application/json"
      },
      body: JSON.stringify({ conversation, currentModel, currentMood })
    })
    return (await response.json())
  }

  return (
    <>
      <Head>
        <title>Create Next App</title>
        <meta name="description" content="Generated by create next app" />
        <meta name="viewport" content="width=device-width, initial-scale=1" />
        <link rel="icon" href="/favicon.ico" />
      </Head>
        <div className={styles.sidebar}>
          <ModelSelector currentModel={currentModel} setCurrentModel={setCurrentModel}/>
          <MoodSelector currentMood={currentMood} setCurrentMood={setCurrentMood}/>
        </div>
      <main className={styles.main}>
        <div className={styles.description}>
          {conversation.map((item,i) => 
            <div className={[i % 2 == 0 ? styles.human: styles.robot, styles.chatcontainer].join(" ")} key={i}>
              {i%2==0? <>
                {/* <Image src="public/human.png" alt="human" width={100} height={100}/>  */}
                <p className={styles.chatlabel}>üë®‚Äçüíª</p>
              </> : <> 
                {/* <Image  src="public/robot.png" alt="robot" width={100} height={100}/> */}
                <p className={styles.chatlabel}>ü§ñ</p>
              </>}
              <p className={styles.chattext}>{item}</p>
            </div>
          )}
        </div>
      </main>
      <div className={styles.chatbox}>
        <ChatBox addToList={appendToConversation} disabled={chatboxDisabled} setDisabled={setChatboxDisabled} />
      </div>
    </>
  )
}

const ModelSelector = ({currentModel, setCurrentModel}: {currentModel:string, setCurrentModel:any}) => {
  // allows user to select between four named models

  const handleModelClicked = (model: string) => {
    console.log(model);
    setCurrentModel(model);
  }
  return (
    <div className={styles.selectorcontainer}>
      <h3>Select model</h3>
      <p className={`${styles.selector} ${styles.disabled}`}>BioGPT</p>
      <p onClick={() => handleModelClicked("ada")} className={`${styles.selector} ${currentModel==="ada" ? styles.selected : ''}`}>GPT-3 Ada</p>
      <p onClick={() => handleModelClicked("curie")} className={`${styles.selector} ${currentModel==="curie" ? styles.selected : ''}`}>GPT-3 Curie</p>
      <p onClick={() => handleModelClicked("davinci")} className={`${styles.selector} ${currentModel==="davinci" ? styles.selected : ''}`}>GPT-3 Davinci</p>
    </div>
  )
}

const MoodSelector = ({ currentMood, setCurrentMood}: {currentMood:string, setCurrentMood:any}) => {
  // allows user to select between four named models

  const handleModelClicked = (model: string) => {
    console.log(model);
    setCurrentMood(model);
  }
  return (
    <div className={styles.selectorcontainer}>
      <h3>Select prompt</h3>
      <p onClick={() => handleModelClicked("chat")} className={`${styles.selector} ${currentMood==="chat" ? styles.selected : ''}`}>chat</p>
      <p onClick={() => handleModelClicked("none")} className={`${styles.selector} ${currentMood==="none" ? styles.selected : ''}`}>none</p>
      <p onClick={() => handleModelClicked("bing-normal")} className={`${styles.selector} ${currentMood==="bing-normal" ? styles.selected : ''}`}>Bing</p>
      <p onClick={() => handleModelClicked("bing-stoned")} className={`${styles.selector} ${currentMood==="bing-stoned" ? styles.selected : ''}`}>Bing (stoned)</p>
      <p onClick={() => handleModelClicked("bing-cyberpunk")} className={`${styles.selector} ${currentMood==="bing-cyberpunk" ? styles.selected : ''}`}>Bing (cyberpunk)</p>
      <p onClick={() => handleModelClicked("very-safe")} className={`${styles.selector} ${currentMood==="very-safe" ? styles.selected : ''}`}>Very safe</p>
    </div>
  )
}

const ChatBox = ({ addToList, disabled, setDisabled }: {addToList: any, disabled: boolean, setDisabled: any}) => {
  const [message, setMessage] = useState('');

  const handleKeyDown = (e: any) => {
    const keyCode = e.keyCode;
    if(keyCode === 13 && !e.shiftKey) {
      e.preventDefault();
      handleSubmit(e);
    }
  }
  const handleChange = (e: any) => {
    setMessage(e.target.value);
  };

  const handleSubmit = (e: any) => {
    e.preventDefault();
    addToList(message);
    setMessage('');
    setDisabled(true);
  };

  return (
    <form onSubmit={handleSubmit} className={styles.description}>
      <fieldset>
        <textarea value={message} onChange={handleChange} onKeyDown={handleKeyDown}/>
        {/* <button type="submit" disabled={disabled}>Send</button> */}
      </fieldset>
    </form>
  );
};